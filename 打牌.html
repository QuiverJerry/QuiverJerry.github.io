<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€P2Pæ‰‘å…‹å®¤</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px 0; width: 100%; }
        input { padding: 10px; width: 90%; font-size: 16px; margin-bottom: 10px; }
        #logs { background: #f0f0f0; height: 150px; overflow-y: scroll; padding: 10px; font-size: 12px;}
        .hidden { display: none; }
        .card { display: inline-block; border: 1px solid black; padding: 5px 10px; margin: 2px; background: white; }
    </style>
</head>
<body>

    <h2>ğŸƒ P2P æ‰‘å…‹æµ‹è¯•</h2>

    <div id="roleSelect" class="box">
        <button onclick="initHost()">æˆ‘æ˜¯æˆ¿ä¸» (Host)</button>
        <hr>
        <input type="text" id="hostIdInput" placeholder="è¾“å…¥æˆ¿ä¸»çš„ ID">
        <button onclick="initJoin()">åŠ å…¥æˆ¿é—´ (Join)</button>
    </div>

    <div id="gameArea" class="box hidden">
        <div id="myIdDisplay" style="font-weight:bold; color:blue;"></div>
        <div id="hostControls" class="hidden">
            <button onclick="dealCards()">å‘ç‰Œ (ä»…æˆ¿ä¸»)</button>
        </div>
        
        <h3>æˆ‘çš„æ‰‹ç‰Œ:</h3>
        <div id="myHand">ç­‰å¾…å‘ç‰Œ...</div>
        
        <hr>
        <button onclick="playCard()">å‡ºä¸€å¼ ç‰Œ (æµ‹è¯•)</button>
    </div>

    <div id="logs">ç³»ç»Ÿæ—¥å¿—...</div>

    <script>
        let peer = null;
        let conn = null; 
        let connections = []; // æˆ¿ä¸»ç”¨æ¥å­˜æ‰€æœ‰ç©å®¶è¿æ¥
        let isHost = false;

        // åˆå§‹åŒ– Peer
        function initPeer() {
            // ä½¿ç”¨ PeerJS é»˜è®¤å…è´¹æœåŠ¡å™¨
            peer = new Peer(); 
            
            peer.on('open', (id) => {
                log(`æˆ‘çš„ ID: ${id}`);
                document.getElementById('roleSelect').classList.add('hidden');
                document.getElementById('gameArea').classList.remove('hidden');
                document.getElementById('myIdDisplay').innerText = `ID: ${id}`;
                
                if(isHost) {
                    alert(`æˆ¿é—´å·²åˆ›å»ºï¼\nè¯·æŠŠè¿™ä¸ª ID å‘ç»™æœ‹å‹ï¼š\n${id}`);
                    document.getElementById('hostControls').classList.remove('hidden');
                }
            });

            peer.on('connection', (c) => {
                // ä»…æˆ¿ä¸»ä¼šæ”¶åˆ° connection
                if (isHost) {
                    log(`ç©å®¶ ${c.peer} å·²åŠ å…¥!`);
                    connections.push(c);
                    setupConnection(c);
                }
            });

            peer.on('error', (err) => log(`é”™è¯¯: ${err.type}`));
        }

        // === æˆ¿ä¸»é€»è¾‘ ===
        function initHost() {
            isHost = true;
            initPeer();
        }

        // å‘ç‰Œé€»è¾‘ï¼ˆç®€å•çš„æ¨¡æ‹Ÿï¼‰
        function dealCards() {
            const suits = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
            const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
            
            // ç»™æ‰€æœ‰è¿æ¥çš„ç©å®¶å‘ä¸€å¼ éšæœºç‰Œ
            connections.forEach(c => {
                let randomCard = suits[Math.floor(Math.random()*4)] + values[Math.floor(Math.random()*13)];
                c.send({ type: 'DEAL', card: randomCard }); // å‘é€æ•°æ®
            });
            
            // æˆ¿ä¸»è‡ªå·±ä¹Ÿå‘ä¸€å¼ 
            let myCard = suits[Math.floor(Math.random()*4)] + values[Math.floor(Math.random()*13)];
            displayCard(myCard);
            broadcast(`æˆ¿ä¸»å‘äº†ä¸€è½®ç‰Œ`);
        }

        function broadcast(msg) {
            connections.forEach(c => c.send({ type: 'LOG', message: msg }));
            log(msg);
        }

        // === ç©å®¶é€»è¾‘ ===
        function initJoin() {
            isHost = false;
            let hostId = document.getElementById('hostIdInput').value;
            if (!hostId) return alert("è¯·è¾“å…¥æˆ¿ä¸» ID");
            
            initPeer();
            
            // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿ peer open åå†è¿
            setTimeout(() => {
                conn = peer.connect(hostId);
                setupConnection(conn);
            }, 1000);
        }

        // === é€šç”¨è¿æ¥å¤„ç† ===
        function setupConnection(c) {
            c.on('open', () => {
                log("å·²è¿æ¥!");
                if(!isHost) c.send({ type: 'LOG', message: 'æˆ‘è¿›æ¥äº†!' });
            });

            c.on('data', (data) => {
                // å¤„ç†æ”¶åˆ°çš„æ•°æ®
                if (data.type === 'LOG') {
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${data.message}`);
                } else if (data.type === 'DEAL') {
                    displayCard(data.card);
                    log("æ”¶åˆ°ä¸€å¼ ç‰Œ!");
                }
            });
        }

        // æ¨¡æ‹Ÿå‡ºç‰Œ
        function playCard() {
            let msg = "æˆ‘å‡ºäº†ä¸€å¼ ç‰Œ!";
            log(msg);
            if (isHost) {
                broadcast("æˆ¿ä¸»å‡ºç‰Œäº†");
            } else if (conn) {
                conn.send({ type: 'LOG', message: "ç©å®¶å‡ºç‰Œäº†" });
            }
        }

        // === è¾…åŠ©å‡½æ•° ===
        function log(text) {
            const el = document.getElementById('logs');
            el.innerHTML += `<div>${text}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        function displayCard(text) {
            const hand = document.getElementById('myHand');
            if(hand.innerText === 'ç­‰å¾…å‘ç‰Œ...') hand.innerText = '';
            hand.innerHTML += `<div class="card">${text}</div>`;
        }
    </script>
</body>
</html>