<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å¯æ¢¦ç’€ç’¨å®çŸ³: æœ€ç»ˆä¿®æ­£ç‰ˆ</title>
    <style>
        :root {
            --fire: #f44336;      /* çº¢ */
            --water: #2196f3;     /* è“ */
            --electric: #ffeb3b;  /* é»„ */
            --psychic: #f48fb1;   /* ç²‰è‰² (Psychic) */
            --dark: #343a40;      /* é»‘ */
            --masterball: #9c27b0; /* ç´«è‰² (Masterball) */
            --bg-dark: #2c3e50;
            --card-bg: #ecf0f1;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- ç™»å½•ç•Œé¢ --- */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 30px; border-radius: 15px; color: #333; text-align: center; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-box button { width: 100%; padding: 12px; background: #ffcb05; color: #3375b9; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* --- æ¸¸æˆä¸»å¸ƒå±€ --- */
        #gameScreen { display: none; height: 100%; flex-direction: column; }
        .top-bar { height: 45px; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-size: 14px; }
        .main-area { flex: 1; display: flex; overflow: hidden; }

        /* å¸‚åœºåŒº */
        .market-area { flex: 3; padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .card-row { display: flex; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; align-items: center; min-height: 160px; }
        .row-info { width: 45px; text-align: center; color: #aaa; font-size: 11px; }

        /* å¡ç‰Œæ ·å¼ */
        .card {
            width: 100px; height: 140px; background: var(--card-bg); border-radius: 8px;
            color: #333; position: relative; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: space-between; padding: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid transparent;
        }
        .card:hover { transform: translateY(-25px) scale(1.1); z-index: 100 !important; border-color: #ffcb05; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card-header { display: flex; justify-content: space-between; font-weight: bold; align-items: center; }
        .card-points { font-size: 16px; }
        .card-gems { display: flex; gap: 1px; }
        .gem-mini { font-size: 14px; }

        .card-img { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; background: rgba(0,0,0,0.05); margin: 4px 0; border-radius: 4px; text-align: center; position: relative; }
        .evo-info { font-size: 8px; width: 100%; text-align: center; font-weight: normal; line-height: 1.1; margin-top: 2px; }
        .evo-to { color: #2196f3; font-weight: bold; }

        .card-cost { display: flex; flex-wrap: wrap; gap: 1px; }
        .cost-bubble { width: 14px; height: 14px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 8px; font-weight: bold; text-shadow: 0 0 1px black; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 260px; background: rgba(0,0,0,0.2); border-left: 1px solid #444; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-title { font-size: 11px; text-align: center; padding: 8px; background: rgba(0,0,0,0.3); color: #888; }
        .token-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; padding: 10px; border-bottom: 1px solid #444; }
        .token { width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); text-shadow: 1px 1px 1px black; font-size: 12px; }
        
        .opponent-item { background: rgba(255,255,255,0.05); margin: 5px 10px; padding: 8px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; }
        .opp-header { display: flex; justify-content: space-between; font-size: 13px; font-weight: bold; }

        /* åº•éƒ¨æ§åˆ¶å° */
        .player-dashboard { height: 180px; background: #1a1a1a; border-top: 2px solid #444; display: flex; padding: 10px; gap: 10px; }
        .dashboard-sec { border-right: 1px solid #333; padding-right: 10px; display: flex; flex-direction: column; }
        .sec-label { font-size: 10px; color: #666; margin-bottom: 5px; text-align: center; }

        .stack-container { display: flex; padding-left: 20px; align-items: center; height: 140px; }
        .stack-container .card { margin-left: -65px; box-shadow: -2px 0 5px rgba(0,0,0,0.2); transform: scale(0.9); }
        .stack-container .card:first-child { margin-left: 0; }

        .bg-fire { background-color: var(--fire); }
        .bg-water { background-color: var(--water); }
        .bg-electric { background-color: var(--electric); }
        .bg-psychic { background-color: var(--psychic); }
        .bg-dark { background-color: var(--dark); }
        .bg-masterball { background-color: var(--masterball); }

        #actionModal, #inspectModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #fff; color: #333; padding: 20px; border-radius: 12px; text-align: center; width: 500px; max-height: 85vh; overflow-y: auto; }
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin-top: 8px; }
        .inspect-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; background: #f0f0f0; padding: 10px; border-radius: 8px; margin-top: 5px; }

        .log-area { position: absolute; bottom: 190px; right: 280px; width: 220px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 8px; font-size: 10px; max-height: 80px; overflow: hidden; pointer-events: none; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:#2a5298">ğŸ’ å®å¯æ¢¦ç’€ç’¨å®çŸ³</h2>
            <p style="font-size:11px; margin-bottom:15px; color:#666;">90å¼ å…¨å›¾é‰´æœ€ç»ˆä¿®æ­£ç‰ˆ</p>
            <input type="text" id="serverUrl" value="ws://localhost:8001">
            <input type="text" id="roomId" placeholder="æˆ¿é—´å·" value="101">
            <input type="text" id="userId" placeholder="åå­—" value="å°æ™º">
            <button onclick="joinGame()">è¿›å…¥èµ›åœº</button>
        </div>
    </div>

    <div id="gameScreen">
        <div class="top-bar">
            <div id="roomDisplay">åŠ è½½ä¸­...</div>
            <button onclick="resetTable()" style="background:#f44336; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer;">é‡ç½®æ¯”èµ›</button>
        </div>

        <div class="main-area">
            <div class="market-area" id="marketArea"></div>
            <div class="sidebar">
                <div class="sidebar-title">å…¬å…±èµ„æº (ç‚¹å‡»æ‹¿å–)</div>
                <div class="token-container" id="bankTokens"></div>
                <div class="sidebar-title">å¯¹æ‰‹è¯¦æƒ… (ç‚¹å‡»æŸ¥çœ‹æ‰‹ç‰Œ)</div>
                <div id="opponentsList"></div>
            </div>
        </div>

        <div class="log-area" id="gameLog"></div>

        <div class="player-dashboard">
            <div class="dashboard-sec" style="min-width:130px;">
                <div class="sec-label">èµ„æº (ç‚¹å‡»å½’è¿˜)</div>
                <div id="myTokensContainer" style="display:flex; flex-wrap:wrap; gap:4px; justify-content:center;"></div>
            </div>
            <div class="dashboard-sec" style="flex: 1;">
                <div class="sec-label">é¢„ç•™æ‰‹ç‰Œ (å †å )</div>
                <div id="myHandContainer" class="stack-container"></div>
            </div>
            <div class="dashboard-sec" style="flex: 2; border-right:none;">
                <div class="sec-label">å·²æ•æ‰å›¾é‰´ (å †å )</div>
                <div id="myTableauContainer" class="stack-container"></div>
            </div>
        </div>
    </div>

    <div id="inspectModal">
        <div class="modal-content">
            <h3 id="inspectTitle">æƒ…æŠ¥è¯¦æƒ…</h3>
            <div id="inspectCaught" class="inspect-grid"></div>
            <div style="font-size:11px; color:#555; margin-top:10px;">é¢„ç•™æ‰‹ç‰Œ</div>
            <div id="inspectReserved" class="inspect-grid"></div>
            <button class="modal-btn" style="background:#444;" onclick="document.getElementById('inspectModal').style.display='none'">å…³é—­è¯¦æƒ…</button>
        </div>
    </div>

    <div id="actionModal">
        <div class="modal-content" style="width:320px;">
            <h3 id="modalCardName">å¡ç‰Œ</h3>
            <p id="modalDesc" style="font-size:12px; margin:10px 0; color:#666; white-space:pre-line; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 6px;"></p>
            <div id="modalButtons"></div>
            <button class="modal-btn" style="background:#999;" onclick="document.getElementById('actionModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

<script>
    // ä¿®æ­£å›¾æ ‡ï¼špsychic ä¸ºç²‰è‰²çˆ±å¿ƒçƒï¼Œmasterball ä¸ºç´«è‰²å¤§å¸ˆçƒ
    const ICONS = { fire: 'ğŸ”¥', water: 'ğŸ’§', electric: 'âš¡', psychic: 'ğŸ’–', dark: 'âš«', masterball: 'ğŸ' };

    const RAW_CARDS = {
        lvl1: [
            { name: 'æ°å°¼é¾Ÿ', points: 1, gem: 'fire', cost: { fire: 4 }, evoTo: 'å¡å’ªé¾Ÿ', evoFee: 'éœ€3é»‘' },
            { name: 'æ°å°¼é¾Ÿ', points: 1, gem: 'fire', cost: { psychic: 3, water: 2 }, evoTo: 'å¡å’ªé¾Ÿ', evoFee: 'éœ€3é»‘' },
            { name: 'è…•åŠ›', points: 0, gem: 'fire', cost: { electric: 2, psychic: 1, dark: 1 }, evoTo: 'è±ªåŠ›', evoFee: 'éœ€3é»„' },
            { name: 'è…•åŠ›', points: 0, gem: 'fire', cost: { water: 1, electric: 1, psychic: 1, dark: 1 }, evoTo: 'è±ªåŠ›', evoFee: 'éœ€3é»„' },
            { name: 'å–‡å­èŠ½', points: 0, gem: 'fire', cost: { dark: 2, water: 1 }, evoTo: 'å£å‘†èŠ±', evoFee: 'éœ€2ç²‰' },
            { name: 'å–‡å­èŠ½', points: 0, gem: 'fire', cost: { psychic: 2, fire: 2 }, evoTo: 'å£å‘†èŠ±', evoFee: 'éœ€2ç²‰' },
            { name: 'å–‡å­èŠ½', points: 0, gem: 'fire', cost: { electric: 3 }, evoTo: 'å£å‘†èŠ±', evoFee: 'éœ€2ç²‰' },
            { name: 'å°ç«é¾™', points: 1, gem: 'water', cost: { water: 4 }, evoTo: 'ç«æé¾™', evoFee: 'éœ€3é»„' },
            { name: 'å°ç«é¾™', points: 1, gem: 'water', cost: { dark: 3, psychic: 2 }, evoTo: 'ç«æé¾™', evoFee: 'éœ€3é»„' },
            { name: 'å°æ‹³çŸ³', points: 0, gem: 'water', cost: { fire: 2, electric: 1, water: 1 }, evoTo: 'éš†éš†çŸ³', evoFee: 'éœ€3ç²‰' },
            { name: 'å°æ‹³çŸ³', points: 0, gem: 'water', cost: { dark: 1, electric: 1, psychic: 1, fire: 1 }, evoTo: 'éš†éš†çŸ³', evoFee: 'éœ€3ç²‰' },
            { name: 'æ³¢æ³¢', points: 0, gem: 'water', cost: { electric: 2, dark: 1 }, evoTo: 'æ¯”æ¯”é¸Ÿ', evoFee: 'éœ€2çº¢' },
            { name: 'æ³¢æ³¢', points: 0, gem: 'water', cost: { fire: 2, water: 2 }, evoTo: 'æ¯”æ¯”é¸Ÿ', evoFee: 'éœ€2çº¢' },
            { name: 'æ³¢æ³¢', points: 0, gem: 'water', cost: { psychic: 3 }, evoTo: 'æ¯”æ¯”é¸Ÿ', evoFee: 'éœ€2çº¢' },
            { name: 'å¦™è›™ç§å­', points: 1, gem: 'electric', cost: { electric: 4 }, evoTo: 'å¦™è›™è‰', evoFee: 'éœ€3ç²‰' },
            { name: 'å¦™è›™ç§å­', points: 1, gem: 'electric', cost: { fire: 3, dark: 2 }, evoTo: 'å¦™è›™è‰', evoFee: 'éœ€3ç²‰' },
            { name: 'é¬¼æ–¯', points: 0, gem: 'electric', cost: { psychic: 2, dark: 1, fire: 1 }, evoTo: 'é¬¼æ–¯é€š', evoFee: 'éœ€3é»‘' },
            { name: 'é¬¼æ–¯', points: 0, gem: 'electric', cost: { water: 1, fire: 1, psychic: 1, dark: 1 }, evoTo: 'é¬¼æ–¯é€š', evoFee: 'éœ€3é»‘' },
            { name: 'å°¼å¤šå…°', points: 0, gem: 'electric', cost: { fire: 2, psychic: 1 }, evoTo: 'å°¼å¤šå¨œ', evoFee: 'éœ€2è“' },
            { name: 'å°¼å¤šå…°', points: 0, gem: 'electric', cost: { water: 2, electric: 2 }, evoTo: 'å°¼å¤šå¨œ', evoFee: 'éœ€2è“' },
            { name: 'å°¼å¤šå…°', points: 0, gem: 'electric', cost: { dark: 3 }, evoTo: 'å°¼å¤šå¨œ', evoFee: 'éœ€2è“' },
            { name: 'å‡¯è¥¿', points: 1, gem: 'psychic', cost: { psychic: 4 }, evoTo: 'å‹‡åŸºæ‹‰', evoFee: 'éœ€3çº¢' },
            { name: 'å‡¯è¥¿', points: 1, gem: 'psychic', cost: { water: 3, electric: 2 }, evoTo: 'å‹‡åŸºæ‹‰', evoFee: 'éœ€3çº¢' },
            { name: 'ç»¿æ¯›è™«', points: 0, gem: 'psychic', cost: { dark: 2, water: 1, electric: 1 }, evoTo: 'é“ç”²è›¹', evoFee: 'éœ€3è“' },
            { name: 'ç»¿æ¯›è™«', points: 0, gem: 'psychic', cost: { water: 1, electric: 1, fire: 1, dark: 1 }, evoTo: 'é“ç”²è›¹', evoFee: 'éœ€3è“' },
            { name: 'èšŠé¦™èŒèšª', points: 0, gem: 'psychic', cost: { water: 2, electric: 1 }, evoTo: 'èšŠé¦™å›', evoFee: 'éœ€2é»‘' },
            { name: 'èšŠé¦™èŒèšª', points: 0, gem: 'psychic', cost: { psychic: 2, dark: 2 }, evoTo: 'èšŠé¦™å›', evoFee: 'éœ€2é»‘' },
            { name: 'èšŠé¦™èŒèšª', points: 0, gem: 'psychic', cost: { fire: 3 }, evoTo: 'èšŠé¦™å›', evoFee: 'éœ€2é»‘' },
            { name: 'è¿·ä½ é¾™', points: 1, gem: 'dark', cost: { dark: 4 }, evoTo: 'å“ˆå…‹é¾™', evoFee: 'éœ€3è“' },
            { name: 'è¿·ä½ é¾™', points: 1, gem: 'dark', cost: { electric: 3, fire: 2 }, evoTo: 'å“ˆå…‹é¾™', evoFee: 'éœ€3è“' },
            { name: 'ç‹¬è§’è™«', points: 0, gem: 'dark', cost: { water: 2, fire: 1, psychic: 1 }, evoTo: 'é“å£³è›¹', evoFee: 'éœ€3çº¢' },
            { name: 'ç‹¬è§’è™«', points: 0, gem: 'dark', cost: { fire: 1, electric: 1, psychic: 1, water: 1 }, evoTo: 'é“å£³è›¹', evoFee: 'éœ€3çº¢' },
            { name: 'èµ°è·¯è‰', points: 0, gem: 'dark', cost: { psychic: 2, fire: 1 }, evoTo: 'è‡­è‡­èŠ±', evoFee: 'éœ€2é»„' },
            { name: 'èµ°è·¯è‰', points: 0, gem: 'dark', cost: { electric: 2, dark: 2 }, evoTo: 'è‡­è‡­èŠ±', evoFee: 'éœ€2é»„' },
            { name: 'èµ°è·¯è‰', points: 0, gem: 'dark', cost: { water: 3 }, evoTo: 'è‡­è‡­èŠ±', evoFee: 'éœ€2é»„' }
        ],
        lvl2: [
            { name: 'å¡å’ªé¾Ÿ', points: 3, gem: 'fire', cost: { fire: 6 }, evoFrom: 'æ°å°¼é¾Ÿ', evoTo: 'æ°´ç®­é¾Ÿ', evoFee: 'éœ€4ç²‰' },
            { name: 'å¡å’ªé¾Ÿ', points: 3, gem: 'fire', cost: { water: 4, dark: 4, psychic: 1 }, evoFrom: 'æ°å°¼é¾Ÿ', evoTo: 'æ°´ç®­é¾Ÿ', evoFee: 'éœ€4ç²‰' },
            { name: 'è±ªåŠ›', points: 2, gem: 'fire', cost: { fire: 5, psychic: 2 }, evoFrom: 'è…•åŠ›', evoTo: 'æ€ªåŠ›', evoFee: 'éœ€3è“' },
            { name: 'è±ªåŠ›', points: 2, gem: 'fire', cost: { electric: 4, dark: 2, water: 1 }, evoFrom: 'è…•åŠ›', evoTo: 'æ€ªåŠ›', evoFee: 'éœ€3è“' },
            { name: 'å£å‘†èŠ±', points: 1, gem: 'fire', cost: { fire: 3, dark: 2, electric: 2 }, evoFrom: 'å–‡å­èŠ½', evoTo: 'å¤§é£ŸèŠ±', evoFee: 'éœ€4ç²‰' },
            { name: 'å£å‘†èŠ±', points: 1, gem: 'fire', cost: { psychic: 3, electric: 2, dark: 2 }, evoFrom: 'å–‡å­èŠ½', evoTo: 'å¤§é£ŸèŠ±', evoFee: 'éœ€4ç²‰' },
            { name: 'ç«æé¾™', points: 3, gem: 'water', cost: { water: 6 }, evoFrom: 'å°ç«é¾™', evoTo: 'å–·ç«é¾™', evoFee: 'éœ€4çº¢' },
            { name: 'ç«æé¾™', points: 3, gem: 'water', cost: { electric: 4, dark: 4, fire: 1 }, evoFrom: 'å°ç«é¾™', evoTo: 'å–·ç«é¾™', evoFee: 'éœ€4çº¢' },
            { name: 'éš†éš†çŸ³', points: 2, gem: 'water', cost: { water: 5, fire: 2 }, evoFrom: 'å°æ‹³çŸ³', evoTo: 'éš†éš†å²©', evoFee: 'éœ€3é»‘' },
            { name: 'éš†éš†çŸ³', points: 2, gem: 'water', cost: { psychic: 4, electric: 2, dark: 1 }, evoFrom: 'å°æ‹³çŸ³', evoTo: 'éš†éš†å²©', evoFee: 'éœ€3é»‘' },
            { name: 'æ¯”æ¯”é¸Ÿ', points: 1, gem: 'water', cost: { water: 3, psychic: 2, dark: 2 }, evoFrom: 'æ³¢æ³¢', evoTo: 'å¤§æ¯”é¸Ÿ', evoFee: 'éœ€4çº¢' },
            { name: 'æ¯”æ¯”é¸Ÿ', points: 1, gem: 'water', cost: { fire: 3, electric: 2, psychic: 2 }, evoFrom: 'æ³¢æ³¢', evoTo: 'å¤§æ¯”é¸Ÿ', evoFee: 'éœ€4çº¢' },
            { name: 'å¦™è›™è‰', points: 3, gem: 'electric', cost: { electric: 6 }, evoFrom: 'å¦™è›™ç§å­', evoTo: 'å¦™è›™èŠ±', evoFee: 'éœ€4è“' },
            { name: 'å¦™è›™è‰', points: 3, gem: 'electric', cost: { fire: 4, psychic: 4, water: 1 }, evoFrom: 'å¦™è›™ç§å­', evoTo: 'å¦™è›™èŠ±', evoFee: 'éœ€4è“' },
            { name: 'é¬¼æ–¯é€š', points: 2, gem: 'electric', cost: { electric: 5, water: 2 }, evoFrom: 'é¬¼æ–¯', evoTo: 'è€¿é¬¼', evoFee: 'éœ€3çº¢' },
            { name: 'é¬¼æ–¯é€š', points: 2, gem: 'electric', cost: { dark: 4, psychic: 2, fire: 1 }, evoFrom: 'é¬¼æ–¯', evoTo: 'è€¿é¬¼', evoFee: 'éœ€3çº¢' },
            { name: 'å°¼å¤šå¨œ', points: 1, gem: 'electric', cost: { electric: 3, fire: 2, psychic: 2 }, evoFrom: 'å°¼å¤šå…°', evoTo: 'å°¼å¤šå', evoFee: 'éœ€4è“' },
            { name: 'å°¼å¤šå¨œ', points: 1, gem: 'electric', cost: { water: 3, dark: 2, psychic: 2 }, evoFrom: 'å°¼å¤šå…°', evoTo: 'å°¼å¤šå', evoFee: 'éœ€4è“' },
            { name: 'å‹‡åŸºæ‹‰', points: 3, gem: 'psychic', cost: { psychic: 6 }, evoFrom: 'å‡¯è¥¿', evoTo: 'èƒ¡åœ°', evoFee: 'éœ€4é»‘' },
            { name: 'å‹‡åŸºæ‹‰', points: 3, gem: 'psychic', cost: { fire: 4, electric: 4, dark: 1 }, evoFrom: 'å‡¯è¥¿', evoTo: 'èƒ¡åœ°', evoFee: 'éœ€4é»‘' },
            { name: 'é“ç”²è›¹', points: 2, gem: 'psychic', cost: { psychic: 5, dark: 2 }, evoFrom: 'ç»¿æ¯›è™«', evoTo: 'å·´å¤§è¶', evoFee: 'éœ€3é»„' },
            { name: 'é“ç”²è›¹', points: 2, gem: 'psychic', cost: { water: 4, fire: 2, electric: 1 }, evoFrom: 'ç»¿æ¯›è™«', evoTo: 'å·´å¤§è¶', evoFee: 'éœ€3é»„' },
            { name: 'èšŠé¦™å›', points: 1, gem: 'psychic', cost: { psychic: 3, water: 2, electric: 2 }, evoFrom: 'èšŠé¦™èŒèšª', evoTo: 'èšŠé¦™æ³³å£«', evoFee: 'éœ€4é»‘' },
            { name: 'èšŠé¦™å›', points: 1, gem: 'psychic', cost: { dark: 3, fire: 2, water: 2 }, evoFrom: 'èšŠé¦™èŒèšª', evoTo: 'èšŠé¦™æ³³å£«', evoFee: 'éœ€4é»‘' },
            { name: 'å“ˆå…‹é¾™', points: 3, gem: 'dark', cost: { dark: 6 }, evoFrom: 'è¿·ä½ é¾™', evoTo: 'å¿«é¾™', evoFee: 'éœ€4é»„' },
            { name: 'å“ˆå…‹é¾™', points: 3, gem: 'dark', cost: { psychic: 4, water: 4, electric: 1 }, evoFrom: 'è¿·ä½ é¾™', evoTo: 'å¿«é¾™', evoFee: 'éœ€4é»„' },
            { name: 'é“å£³è›¹', points: 2, gem: 'dark', cost: { dark: 5, electric: 2 }, evoFrom: 'ç‹¬è§’è™«', evoTo: 'å¤§é’ˆèœ‚', evoFee: 'éœ€3ç²‰' },
            { name: 'é“å£³è›¹', points: 2, gem: 'dark', cost: { fire: 4, water: 2, psychic: 1 }, evoFrom: 'ç‹¬è§’è™«', evoTo: 'å¤§é’ˆèœ‚', evoFee: 'éœ€3ç²‰' },
            { name: 'è‡­è‡­èŠ±', points: 1, gem: 'dark', cost: { dark: 3, water: 2, fire: 2 }, evoFrom: 'èµ°è·¯è‰', evoTo: 'éœ¸ç‹èŠ±', evoFee: 'éœ€4é»„' },
            { name: 'è‡­è‡­èŠ±', points: 1, gem: 'dark', cost: { electric: 3, water: 2, fire: 2 }, evoFrom: 'èµ°è·¯è‰', evoTo: 'éœ¸ç‹èŠ±', evoFee: 'éœ€4é»„' }
        ],
        lvl3: [
            { name: 'æ°´ç®­é¾Ÿ', points: 5, gem: 'fire', cost: { water: 7, dark: 3 }, evoFrom: 'å¡å’ªé¾Ÿ' },
            { name: 'æ€ªåŠ›', points: 4, gem: 'fire', cost: { electric: 6, psychic: 4 }, evoFrom: 'è±ªåŠ›' },
            { name: 'å¤§é£ŸèŠ±', points: 3, gem: 'fire', cost: { fire: 5, dark: 2, water: 2 }, evoFrom: 'å£å‘†èŠ±' },
            { name: 'å–·ç«é¾™', points: 5, gem: 'water', cost: { dark: 7, electric: 3 }, evoFrom: 'ç«æé¾™' },
            { name: 'éš†éš†å²©', points: 4, gem: 'water', cost: { psychic: 6, fire: 4 }, evoFrom: 'éš†éš†çŸ³' },
            { name: 'å¤§æ¯”é¸Ÿ', points: 3, gem: 'water', cost: { water: 5, dark: 2, electric: 2 }, evoFrom: 'æ¯”æ¯”é¸Ÿ' },
            { name: 'å¦™è›™èŠ±', points: 5, gem: 'electric', cost: { fire: 7, psychic: 3 }, evoFrom: 'å¦™è›™è‰' },
            { name: 'è€¿é¬¼', points: 4, gem: 'electric', cost: { dark: 6, water: 4 }, evoFrom: 'é¬¼æ–¯é€š' },
            { name: 'å°¼å¤šå', points: 3, gem: 'electric', cost: { electric: 5, fire: 2, psychic: 2 }, evoFrom: 'å°¼å¤šå¨œ' },
            { name: 'èƒ¡åœ°', points: 5, gem: 'psychic', cost: { electric: 7, fire: 3 }, evoFrom: 'å‹‡åŸºæ‹‰' },
            { name: 'å·´å¤§è¶', points: 4, gem: 'psychic', cost: { water: 6, dark: 4 }, evoFrom: 'é“ç”²è›¹' },
            { name: 'èšŠé¦™æ³³å£«', points: 3, gem: 'psychic', cost: { psychic: 5, electric: 2, fire: 2 }, evoFrom: 'èšŠé¦™å›' },
            { name: 'å¿«é¾™', points: 5, gem: 'dark', cost: { psychic: 7, water: 3 }, evoFrom: 'å“ˆå…‹é¾™' },
            { name: 'å¤§é’ˆèœ‚', points: 4, gem: 'dark', cost: { fire: 6, electric: 4 }, evoFrom: 'é“å£³è›¹' },
            { name: 'éœ¸ç‹èŠ±', points: 3, gem: 'dark', cost: { dark: 5, water: 2, psychic: 2 }, evoFrom: 'è‡­è‡­èŠ±' }
        ],
        legends: [
            { name: 'æ€¥å†»é¸Ÿ', points: 2, gem: 'electric', cost: { masterball: 1, fire: 3, psychic: 3, dark: 3 } },
            { name: 'é—ªç”µé¸Ÿ', points: 2, gem: 'fire', cost: { masterball: 1, psychic: 3, water: 3, electric: 3 } },
            { name: 'ç«ç„°é¸Ÿ', points: 2, gem: 'psychic', cost: { masterball: 1, water: 3, electric: 3, dark: 3 } },
            { name: 'æ¢¦å¹»', points: 2, gem: 'water', cost: { masterball: 1, dark: 3, electric: 3, fire: 3 } },
            { name: 'è¶…æ¢¦', points: 2, gem: 'dark', cost: { masterball: 1, psychic: 3, fire: 3, water: 3 } },
            { name: 'åŒ–çŸ³ç¿¼é¾™', points: 0, gem: 'electric', cost: { masterball: 1, water: 3, psychic: 2 } },
            { name: 'æ‹‰æ™®æ‹‰æ–¯', points: 0, gem: 'fire', cost: { masterball: 1, dark: 3, water: 2 } },
            { name: 'å¡æ¯”å…½', points: 0, gem: 'psychic', cost: { masterball: 1, fire: 3, dark: 2 } },
            { name: 'ç™¾å˜æ€ª', points: 0, gem: 'water', cost: { masterball: 1, psychic: 3, electric: 2 } },
            { name: 'ä¼Šå¸ƒ', points: 0, gem: 'dark', cost: { masterball: 1, electric: 3, fire: 2 } }
        ]
    };

    let ws = null, myId = '', roomId = '';
    let localState = { tokens: {}, market: {}, decks: {}, players: {}, logs: [] };

    function joinGame() {
        myId = document.getElementById('userId').value;
        roomId = document.getElementById('roomId').value;
        ws = new WebSocket(document.getElementById('serverUrl').value);
        ws.onopen = () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            send({ type: 'EnterRoom', room: roomId, id: myId });
            setTimeout(() => send({ type: 'SyncRequest' }), 300);
        };
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === 'UpdateState') { localState = msg.state; render(); }
            else if (msg.type === 'InitializeRoomState' && !msg.state) { resetTable(); }
        };
    }

    function send(data) { if(ws && ws.readyState === 1) ws.send(JSON.stringify(data)); }

    function resetTable() {
        const d = JSON.parse(JSON.stringify(RAW_CARDS));
        for(let k in d) d[k].sort(() => Math.random() - 0.5);
        
        const playerCount = Object.keys(localState.players).length || 1;
        let countPerColor = 7;
        if(playerCount === 2) countPerColor = 4;
        else if(playerCount === 3) countPerColor = 5;

        localState = {
            tokens: { fire: countPerColor, water: countPerColor, electric: countPerColor, psychic: countPerColor, dark: countPerColor, masterball: 5 },
            decks: d,
            market: { lvl1: [], lvl2: [], lvl3: [], legends: [] },
            players: { [myId]: { tokens: {fire:0,water:0,electric:0,psychic:0,dark:0,masterball:0}, reserved: [], caught: [] } },
            logs: ["å¤§å¸ˆçƒ 5, å…¶ä»– " + countPerColor]
        };
        autoRefill(); broadcast();
    }

    function autoRefill() {
        const lim = { legends: 3, lvl3: 4, lvl2: 4, lvl1: 4 };
        for(let k in lim) {
            while(localState.market[k].length < lim[k] && localState.decks[k].length > 0) {
                localState.market[k].push(localState.decks[k].pop());
            }
        }
    }

    function broadcast(log) {
        if(log) localState.logs.push(`[${new Date().toLocaleTimeString().slice(0,5)}] ${log}`);
        if(localState.logs.length > 8) localState.logs.shift();
        send({ type: 'UpdateState', state: localState });
        render();
    }

    function buyCard(loc, idx, card, mode) {
        const p = localState.players[myId];
        if (mode === 'reserve') {
            if (p.reserved.length >= 3) return alert("é¢„ç•™å·²æ»¡");
            removeFrom(loc, idx); p.reserved.push(card);
            if(localState.tokens.masterball > 0) { localState.tokens.masterball--; p.tokens.masterball++; }
            broadcast(`${myId} é¢„ç•™äº† ${card.name}`);
        } else if (mode === 'evolve') {
            const preIdx = p.caught.findIndex(c => c.name === card.evoFrom);
            p.caught.splice(preIdx, 1);
            removeFrom(loc, idx); p.caught.push(card);
            broadcast(`${myId} è¿›åŒ–ä¸º ${card.name}`);
        } else {
            removeFrom(loc, idx); p.caught.push(card);
            broadcast(`${myId} æ•æ‰äº† ${card.name}`);
        }
        autoRefill(); broadcast();
    }

    function removeFrom(loc, idx) {
        if (loc === 'hand') localState.players[myId].reserved.splice(idx, 1);
        else localState.market[loc.split('_')[1]].splice(idx, 1);
    }

    function render() {
        document.getElementById('roomDisplay').textContent = `è®­ç»ƒå®¶: ${myId} | æˆ¿é—´: ${roomId}`;
        
        const m = document.getElementById('marketArea'); m.innerHTML = '';
        const rows = { legends: 'ç¨€æœ‰', lvl3: 'æœ€ç»ˆ', lvl2: 'äºŒé˜¶', lvl1: 'ä¸€é˜¶' };
        Object.entries(rows).forEach(([k, label]) => {
            const r = document.createElement('div'); r.className = 'card-row';
            r.innerHTML = `<div class="row-info"><div>${label}</div><div style="font-size:9px;">åº“:${localState.decks[k].length}</div></div>`;
            localState.market[k].forEach((c, i) => r.appendChild(renderCard(c, () => showAction(`market_${k}`, i, c))));
            m.appendChild(r);
        });

        const bank = document.getElementById('bankTokens'); bank.innerHTML = '';
        ['fire', 'water', 'electric', 'psychic', 'dark', 'masterball'].forEach(c => {
            const t = document.createElement('div'); t.className = `token bg-${c}`; t.textContent = localState.tokens[c];
            t.onclick = () => { if(localState.tokens[c]>0){localState.tokens[c]--; localState.players[myId].tokens[c]++; broadcast();} };
            bank.appendChild(t);
        });

        const oppDiv = document.getElementById('opponentsList'); oppDiv.innerHTML = '';
        Object.entries(localState.players).forEach(([pid, pData]) => {
            if(pid === myId) return;
            const score = pData.caught.reduce((sum, c) => sum + (c.points || 0), 0);
            const item = document.createElement('div'); item.className = 'opponent-item';
            item.onclick = () => inspectPlayer(pid, pData);
            item.innerHTML = `<div class="opp-header"><span>${pid}</span><span style="color:#ffcb05;">ğŸ† ${score}</span></div>
                              <div style="font-size:10px; color:#aaa;">å·²æ•: ${pData.caught.length} | é¢„ç•™: ${pData.reserved.length}</div>`;
            oppDiv.appendChild(item);
        });

        const me = localState.players[myId];
        if(me) {
            const t = document.getElementById('myTokensContainer'); t.innerHTML = '';
            Object.entries(me.tokens).forEach(([c, n]) => { if(n>0) {
                const el = document.createElement('div'); el.className = `token bg-${c}`; el.style.width='28px'; el.style.height='28px'; el.textContent = n;
                el.onclick = () => {me.tokens[c]--; localState.tokens[c]++; broadcast();}; t.appendChild(el);
            }});
            const h = document.getElementById('myHandContainer'); h.innerHTML = '';
            me.reserved.forEach((c, i) => h.appendChild(renderCard(c, () => showAction('hand', i, c))));
            const tab = document.getElementById('myTableauContainer'); tab.innerHTML = '';
            me.caught.forEach(c => tab.appendChild(renderCard(c)));
        }
    }

    function renderCard(card, onClick) {
        const el = document.createElement('div'); el.className = 'card';
        if(onClick) el.onclick = onClick;
        const costHtml = Object.entries(card.cost).map(([c, n]) => `<div class="cost-bubble bg-${c}">${n}</div>`).join('');
        
        let evoText = "";
        if(card.evoFrom) evoText += `<div class="evo-from">ç”± ${card.evoFrom} è¿›åŒ–</div>`;
        if(card.evoTo) evoText += `<div class="evo-to">è¿›åŒ–è‡³ ${card.evoTo} (${card.evoFee})</div>`;

        let gemHtml = `<span>${card.gem ? ICONS[card.gem] : ''}</span>`;
        const isLegend = RAW_CARDS.legends.some(l => l.name === card.name);
        if(isLegend) {
            gemHtml = `<div class="card-gems">
                        <span class="gem-mini">${ICONS[card.gem]}</span>
                        <span class="gem-mini">${ICONS[card.gem]}</span>
                      </div>`;
        }

        el.innerHTML = `
            <div class="card-header"><span class="card-points">${card.points||''}</span>${gemHtml}</div>
            <div class="card-img">${card.name}<div class="evo-info">${evoText}</div></div>
            <div class="card-cost">${costHtml}</div>
        `;
        return el;
    }

    function showAction(loc, idx, card) {
        const modal = document.getElementById('actionModal');
        const btns = document.getElementById('modalButtons');
        document.getElementById('modalCardName').textContent = card.name;
        btns.innerHTML = '';
        const add = (txt, col, fn) => {
            const b = document.createElement('button'); b.className = 'modal-btn'; b.style.background = col; b.textContent = txt;
            b.onclick = () => { fn(); modal.style.display='none'; }; btns.appendChild(b);
        };
        if (loc !== 'hand') {
            add('ç›´æ¥æ•æ‰', '#4caf50', () => buyCard(loc, idx, card, 'buy'));
            add('é¢„ç•™å¡ç‰Œ', '#ff9800', () => buyCard(loc, idx, card, 'reserve'));
            if(card.evoFrom) add(`æ¶ˆè€—å‰ç½®è¿›åŒ–`, '#2196f3', () => buyCard(loc, idx, card, 'evolve'));
        } else {
            add('ä»æ‰‹ç‰Œæ‰“å‡º', '#4caf50', () => buyCard(loc, idx, card, 'buy'));
        }
        modal.style.display = 'flex';
    }

    function inspectPlayer(pid, pData) {
        const modal = document.getElementById('inspectModal');
        document.getElementById('inspectTitle').textContent = `${pid} çš„æƒ…æŠ¥è¯¦æƒ…`;
        const cGrid = document.getElementById('inspectCaught'); cGrid.innerHTML = '';
        const rGrid = document.getElementById('inspectReserved'); rGrid.innerHTML = '';
        pData.caught.forEach(c => { const e = renderCard(c); e.style.transform='none'; cGrid.appendChild(e); });
        pData.reserved.forEach(c => { const e = renderCard(c); e.style.transform='none'; rGrid.appendChild(e); });
        modal.style.display = 'flex';
    }
</script>
</body>
</html>
