<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®å¯æ¢¦ç’€ç’¨å®çŸ³: å¯¹æ‰‹è¯¦æƒ…ç‰ˆ</title>
    <style>
        :root {
            --fire: #f44336; --water: #2196f3; --electric: #ffeb3b;
            --psychic: #f48fb1; --dark: #343a40; --masterball: #9c27b0;
            --bg-dark: #2c3e50; --card-bg: #ecf0f1;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- ç•Œé¢å¸ƒå±€ --- */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .login-box { background: white; padding: 30px; border-radius: 15px; color: #333; text-align: center; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-box button { width: 100%; padding: 12px; background: #ffcb05; color: #3375b9; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

        #gameScreen { display: none; height: 100%; flex-direction: column; }
        .top-bar { height: 50px; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 2px solid #444; }
        .turn-info { display: flex; align-items: center; gap: 15px; }
        #turnIndicator { font-weight: bold; font-size: 14px; padding: 4px 15px; border-radius: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
        
        #endTurnBtn { border: none; padding: 8px 20px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }

        .main-area { flex: 1; display: flex; overflow: hidden; }
        .market-area { flex: 3; padding: 10px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .card-row { display: flex; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; align-items: center; min-height: 160px; }
        .row-info { width: 45px; text-align: center; color: #aaa; font-size: 11px; }

        /* å¡ç‰Œæ ·å¼ */
        .card {
            width: 100px; height: 140px; background: var(--card-bg); border-radius: 8px;
            color: #333; position: relative; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; justify-content: space-between; padding: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid transparent; flex-shrink: 0;
        }
        .card:hover { transform: translateY(-5px); z-index: 50; border-color: #ffcb05; }
        .card-header { display: flex; justify-content: space-between; font-weight: bold; align-items: center; font-size: 14px; }
        .card-img { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.05); margin: 4px 0; border-radius: 4px; text-align: center; }
        
        /* è¿›åŒ–ç›¸å…³æ ·å¼ */
        .evo-container { margin-top: 4px; padding-top: 4px; border-top: 1px dashed #ccc; width: 90%; }
        .evo-label { font-size: 8px; color: #777; margin-bottom: 2px; }
        .evo-target { font-size: 9px; font-weight: bold; color: #d32f2f; display: block; }
        .evo-cost-badge { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; color: white; font-size: 10px; font-weight: bold; text-shadow: 0 0 1px black; border: 1px solid rgba(0,0,0,0.1); margin-top: 2px; }

        .card-cost { display: flex; flex-wrap: wrap; gap: 1px; }
        .cost-bubble { width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 9px; font-weight: bold; text-shadow: 0 0 1px black; }

        /* é¢æ¿ä¸æ—¥å¿— */
        .sidebar { width: 260px; background: rgba(0,0,0,0.2); border-left: 1px solid #444; display: flex; flex-direction: column; }
        .sidebar-title { font-size: 11px; text-align: center; padding: 8px; background: rgba(0,0,0,0.3); color: #888; }
        .token-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; padding: 10px; border-bottom: 1px solid #444; }
        .token { width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; border: 2px solid rgba(255,255,255,0.2); text-shadow: 1px 1px 1px black; }
        
        /* å¯¹æ‰‹åˆ—è¡¨é¡¹æ ·å¼ */
        .opp-item { padding: 8px; background: rgba(255,255,255,0.05); margin: 5px; border-radius: 4px; font-size: 11px; border: 1px solid #444; cursor: pointer; transition: 0.2s; }
        .opp-item:hover { background: rgba(255,255,255,0.15); border-color: #ffcb05; }

        .player-dashboard { height: 180px; background: #1a1a1a; border-top: 2px solid #444; display: flex; padding: 10px; gap: 10px; }
        .dashboard-sec { border-right: 1px solid #333; padding-right: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .stack-container { display: flex; padding-left: 20px; align-items: center; height: 140px; overflow-x: auto; scrollbar-width: none; }
        .stack-container::-webkit-scrollbar { display: none; }
        .stack-container .card { margin-left: -65px; transform: scale(0.9); }
        .stack-container .card:first-child { margin-left: 0; }

        .bg-fire { background-color: var(--fire); }
        .bg-water { background-color: var(--water); }
        .bg-electric { background-color: var(--electric); }
        .bg-psychic { background-color: var(--psychic); }
        .bg-dark { background-color: var(--dark); }
        .bg-masterball { background-color: var(--masterball); }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #fff; color: #333; padding: 20px; border-radius: 12px; text-align: center; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; margin-top: 8px; }
        .log-area { position: absolute; bottom: 195px; right: 280px; width: 220px; background: rgba(0,0,0,0.8); padding: 8px; border-radius: 8px; font-size: 10px; color: #00ff00; pointer-events: none; border: 1px solid #444; }

        /* è¯¦æƒ…å†…å¡ç‰Œå±•ç¤º */
        .detail-row { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-row-title { font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .detail-cards { display: flex; flex-wrap: wrap; gap: 5px; width: 100%; }
        .detail-cards .card { transform: scale(0.85); margin: -10px -5px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:#2a5298; margin-bottom: 10px;">ğŸ’ å®å¯æ¢¦ç’€ç’¨å®çŸ³</h2>
            <input type="text" id="serverUrl" value="ws://localhost:8001">
            <input type="text" id="roomId" placeholder="æˆ¿é—´å·" value="101">
            <input type="text" id="userId" placeholder="åå­—" value="å°æ™º">
            <button onclick="joinGame()">è¿›å…¥èµ›åœº</button>
        </div>
    </div>

    <div id="gameScreen">
        <div class="top-bar">
            <div id="roomDisplay" style="font-size:12px; color:#aaa;">åŠ è½½ä¸­...</div>
            <div class="turn-info">
                <div id="turnIndicator">ç­‰å¾…åˆå§‹åŒ–</div>
                <button id="endTurnBtn" onclick="endTurn()">ç»“æŸå›åˆ</button>
            </div>
            <button onclick="resetTable()" style="background:#f44336; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:11px;">é‡ç½®æ¸¸æˆ</button>
        </div>

        <div class="main-area">
            <div class="market-area" id="marketArea"></div>
            <div class="sidebar">
                <div class="sidebar-title">å…¬å…±èµ„æº (ç‚¹å‡»æ‹¿å–)</div>
                <div class="token-container" id="bankTokens"></div>
                <div class="sidebar-title">å¯¹æ‰‹çŠ¶æ€ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</div>
                <div id="opponentsList" style="overflow-y:auto; flex:1;"></div>
            </div>
        </div>

        <div class="log-area" id="gameLog"></div>

        <div class="player-dashboard">
            <div class="dashboard-sec" style="min-width:130px;">
                <div style="font-size:10px; color:#666; text-align:center;">æˆ‘çš„èµ„æº</div>
                <div id="myTokensContainer" style="display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin-top:10px;"></div>
            </div>
            <div class="dashboard-sec" style="flex: 1;">
                <div style="font-size:10px; color:#666; text-align:center;">é¢„ç•™å¡ç‰Œ</div>
                <div id="myHandContainer" class="stack-container"></div>
            </div>
            <div class="dashboard-sec" style="flex: 2; border-right:none;">
                <div style="font-size:10px; color:#666; text-align:center;">å·²æ•æ‰å›¾é‰´</div>
                <div id="myTableauContainer" class="stack-container"></div>
            </div>
        </div>
    </div>

    <div id="actionModal" class="modal">
        <div class="modal-content" style="width: 340px;">
            <h3 id="modalCardName">å¡ç‰Œ</h3>
            <div id="modalButtons"></div>
            <button class="modal-btn" style="background:#999;" onclick="closeModal('actionModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <h2 id="detailPlayerName" style="color:#2a5298; margin-bottom: 15px;">å¯¹æ‰‹è¯¦æƒ…</h2>
            <div id="detailContent">
                <div class="detail-row">
                    <div class="detail-row-title">ğŸ“¦ é¢„ç•™å¡ç‰Œ (Reserved)</div>
                    <div id="detailReserved" class="detail-cards"></div>
                </div>
                <div class="detail-row">
                    <div class="detail-row-title">ğŸ† å·²è·å¾—å›¾é‰´ (Caught)</div>
                    <div id="detailCaught" class="detail-cards"></div>
                </div>
            </div>
            <button class="modal-btn" style="background:#2c3e50;" onclick="closeModal('detailModal')">å…³é—­</button>
        </div>
    </div>

<script>
    const ICONS = { fire: 'ğŸ”¥', water: 'ğŸ’§', electric: 'âš¡', psychic: 'ğŸ’–', dark: 'âš«', masterball: 'ğŸ' };
    const COLOR_MAP = { 'çº¢': 'fire', 'è“': 'water', 'é»„': 'electric', 'ç²‰': 'psychic', 'é»‘': 'dark' };

    let ws = null, myId = '', roomId = '';
    let localState = { tokens: {}, market: {lvl1:[],lvl2:[],lvl3:[],legends:[]}, decks: {}, players: {}, logs: [], turnIndex: 0, playerOrder: [] };

    // ... [RAW_CARDS_DATA ä¿æŒä¸å˜ï¼Œä¸ºäº†èŠ‚çœç¯‡å¹…è¿™é‡Œå¼•ç”¨ä½ æä¾›çš„å®Œæ•´æ•°æ®] ...
    const RAW_CARDS_DATA = {
        lvl1: [
            // çº¢è‰²ç³»
            { name: 'æ°å°¼é¾Ÿ', points: 1, gem: 'fire', cost: { fire: 4 }, evoTo: 'å¡å’ªé¾Ÿ', evoFee: 'éœ€3è“' },
            { name: 'æ°å°¼é¾Ÿ', points: 1, gem: 'fire', cost: { water: 3, psychic: 2, electric: 1 }, evoTo: 'å¡å’ªé¾Ÿ', evoFee: 'éœ€3è“' },
            { name: 'è…•åŠ›', points: 0, gem: 'fire', cost: { electric: 2, psychic: 1, dark: 1 }, evoTo: 'è±ªåŠ›', evoFee: 'éœ€3é»„' },
            { name: 'è…•åŠ›', points: 0, gem: 'fire', cost: { water: 1, electric: 1, psychic: 1, fire: 1 }, evoTo: 'è±ªåŠ›', evoFee: 'éœ€3é»„' },
            { name: 'å–‡å­èŠ½', points: 0, gem: 'fire', cost: { dark: 2, water: 1 }, evoTo: 'å£å‘†èŠ±', evoFee: 'éœ€2ç´«' },
            { name: 'å–‡å­èŠ½', points: 0, gem: 'fire', cost: { psychic: 2, fire: 2 }, evoTo: 'å£å‘†èŠ±', evoFee: 'éœ€2ç´«' },
            { name: 'å–‡å­èŠ½', points: 0, gem: 'fire', cost: { electric: 3 }, evoTo: 'å£å‘†èŠ±', evoFee: 'éœ€2ç´«' },
            // è“è‰²ç³»
            { name: 'å°ç«é¾™', points: 1, gem: 'water', cost: { water: 4 }, evoTo: 'ç«æé¾™', evoFee: 'éœ€3é»„' },
            { name: 'å°ç«é¾™', points: 1, gem: 'water', cost: { dark: 3, fire: 2 }, evoTo: 'ç«æé¾™', evoFee: 'éœ€3é»„' },
            { name: 'å°æ‹³çŸ³', points: 0, gem: 'water', cost: { fire: 2, electric: 1, water: 1 }, evoTo: 'éš†éš†çŸ³', evoFee: 'éœ€3ç´«' },
            { name: 'å°æ‹³çŸ³', points: 0, gem: 'water', cost: { dark: 1, electric: 1, psychic: 1 }, evoTo: 'éš†éš†çŸ³', evoFee: 'éœ€3ç´«' },
            { name: 'æ³¢æ³¢', points: 0, gem: 'water', cost: { electric: 2, dark: 1 }, evoTo: 'æ¯”æ¯”é¸Ÿ', evoFee: 'éœ€2çº¢' },
            { name: 'æ³¢æ³¢', points: 0, gem: 'water', cost: { water: 2, fire: 2 }, evoTo: 'æ¯”æ¯”é¸Ÿ', evoFee: 'éœ€2çº¢' },
            { name: 'æ³¢æ³¢', points: 0, gem: 'water', cost: { psychic: 3 }, evoTo: 'æ¯”æ¯”é¸Ÿ', evoFee: 'éœ€2çº¢' },
            // é»„è‰²ç³»
            { name: 'å¦™è›™ç§å­', points: 1, gem: 'electric', cost: { electric: 4 }, evoTo: 'å¦™è›™è‰', evoFee: 'éœ€3ç´«' },
            { name: 'å¦™è›™ç§å­', points: 1, gem: 'electric', cost: { fire: 3, dark: 2 }, evoTo: 'å¦™è›™è‰', evoFee: 'éœ€3ç´«' },
            { name: 'é¬¼æ–¯', points: 0, gem: 'electric', cost: { psychic: 2, dark: 1, fire: 1 }, evoTo: 'é¬¼æ–¯é€š', evoFee: 'éœ€3é»‘' },
            { name: 'é¬¼æ–¯', points: 0, gem: 'electric', cost: { water: 1, fire: 1, psychic: 1 }, evoTo: 'é¬¼æ–¯é€š', evoFee: 'éœ€3é»‘' },
            { name: 'å°¼å¤šå…°', points: 0, gem: 'electric', cost: { fire: 2, psychic: 1 }, evoTo: 'å°¼å¤šå¨œ', evoFee: 'éœ€2è“' },
            { name: 'å°¼å¤šå…°', points: 0, gem: 'electric', cost: { water: 2, electric: 2 }, evoTo: 'å°¼å¤šå¨œ', evoFee: 'éœ€2è“' },
            { name: 'å°¼å¤šå…°', points: 0, gem: 'electric', cost: { dark: 3 }, evoTo: 'å°¼å¤šå¨œ', evoFee: 'éœ€2è“' },
            // ç´«è‰²ç³»
            { name: 'å‡¯è¥¿', points: 1, gem: 'psychic', cost: { psychic: 4 }, evoTo: 'å‹‡åŸºæ‹‰', evoFee: 'éœ€3çº¢' },
            { name: 'å‡¯è¥¿', points: 1, gem: 'psychic', cost: { water: 3, electric: 2 }, evoTo: 'å‹‡åŸºæ‹‰', evoFee: 'éœ€3çº¢' },
            { name: 'ç»¿æ¯›è™«', points: 0, gem: 'psychic', cost: { dark: 2, water: 1, electric: 1 }, evoTo: 'é“ç”²è›¹', evoFee: 'éœ€3è“' },
            { name: 'ç»¿æ¯›è™«', points: 0, gem: 'psychic', cost: { water: 1, electric: 1, fire: 1 }, evoTo: 'é“ç”²è›¹', evoFee: 'éœ€3è“' },
            { name: 'èšŠé¦™èŒèšª', points: 0, gem: 'psychic', cost: { water: 2, electric: 1 }, evoTo: 'èšŠé¦™å›', evoFee: 'éœ€2é»‘' },
            { name: 'èšŠé¦™èŒèšª', points: 0, gem: 'psychic', cost: { psychic: 2, dark: 2 }, evoTo: 'èšŠé¦™å›', evoFee: 'éœ€2é»‘' },
            { name: 'èšŠé¦™èŒèšª', points: 0, gem: 'psychic', cost: { fire: 3 }, evoTo: 'èšŠé¦™å›', evoFee: 'éœ€2é»‘' },
            // é»‘è‰²ç³»
            { name: 'è¿·ä½ é¾™', points: 1, gem: 'dark', cost: { dark: 4 }, evoTo: 'å“ˆå…‹é¾™', evoFee: 'éœ€3è“' },
            { name: 'è¿·ä½ é¾™', points: 1, gem: 'dark', cost: { water: 3, fire: 2 }, evoTo: 'å“ˆå…‹é¾™', evoFee: 'éœ€3è“' },
            { name: 'ç‹¬è§’è™«', points: 0, gem: 'dark', cost: { water: 2, fire: 1, psychic: 1 }, evoTo: 'é“å£³è›¹', evoFee: 'éœ€3çº¢' },
            { name: 'ç‹¬è§’è™«', points: 0, gem: 'dark', cost: { fire: 1, electric: 1, psychic: 1 }, evoTo: 'é“å£³è›¹', evoFee: 'éœ€3çº¢' },
            { name: 'èµ°è·¯è‰', points: 0, gem: 'dark', cost: { psychic: 2, fire: 1 }, evoTo: 'è‡­è‡­èŠ±', evoFee: 'éœ€2é»„' },
            { name: 'èµ°è·¯è‰', points: 0, gem: 'dark', cost: { electric: 2, dark: 2 }, evoTo: 'è‡­è‡­èŠ±', evoFee: 'éœ€2é»„' },
            { name: 'èµ°è·¯è‰', points: 0, gem: 'dark', cost: { water: 3 }, evoTo: 'è‡­è‡­èŠ±', evoFee: 'éœ€2é»„' }
        ],
        lvl2: [
            { name: 'å¡å’ªé¾Ÿ', points: 3, gem: 'fire', cost: { water: 4 }, evoFrom: 'æ°å°¼é¾Ÿ', evoTo: 'æ°´ç®­é¾Ÿ', evoFee: 'éœ€4è“' },
            { name: 'å¡å’ªé¾Ÿ', points: 3, gem: 'fire', cost: { fire: 6 }, evoFrom: 'æ°å°¼é¾Ÿ', evoTo: 'æ°´ç®­é¾Ÿ', evoFee: 'éœ€4è“' },
            { name: 'è±ªåŠ›', points: 2, gem: 'fire', cost: { fire: 5, psychic: 2 }, evoFrom: 'è…•åŠ›', evoTo: 'æ€ªåŠ›', evoFee: 'éœ€3è“' },
            { name: 'è±ªåŠ›', points: 2, gem: 'fire', cost: { electric: 4, dark: 2 }, evoFrom: 'è…•åŠ›', evoTo: 'æ€ªåŠ›', evoFee: 'éœ€3è“' },
            { name: 'å£å‘†èŠ±', points: 1, gem: 'fire', cost: { dark: 2, fire: 2, electric: 2 }, evoFrom: 'å–‡å­èŠ½', evoTo: 'å¤§é£ŸèŠ±', evoFee: 'éœ€4ç´«' },
            { name: 'å£å‘†èŠ±', points: 1, gem: 'fire', cost: { psychic: 3, electric: 2 }, evoFrom: 'å–‡å­èŠ½', evoTo: 'å¤§é£ŸèŠ±', evoFee: 'éœ€4ç´«' },
            { name: 'ç«æé¾™', points: 3, gem: 'water', cost: { water: 6 }, evoFrom: 'å°ç«é¾™', evoTo: 'å–·ç«é¾™', evoFee: 'éœ€4çº¢' },
            { name: 'ç«æé¾™', points: 3, gem: 'water', cost: { electric: 4, dark: 4 }, evoFrom: 'å°ç«é¾™', evoTo: 'å–·ç«é¾™', evoFee: 'éœ€4çº¢' },
            { name: 'éš†éš†çŸ³', points: 2, gem: 'water', cost: { water: 5, fire: 2 }, evoFrom: 'å°æ‹³çŸ³', evoTo: 'éš†éš†å²©', evoFee: 'éœ€3é»‘' },
            { name: 'éš†éš†çŸ³', points: 2, gem: 'water', cost: { psychic: 4, electric: 2 }, evoFrom: 'å°æ‹³çŸ³', evoTo: 'éš†éš†å²©', evoFee: 'éœ€3é»‘' },
            { name: 'æ¯”æ¯”é¸Ÿ', points: 1, gem: 'water', cost: { water: 3, psychic: 2, fire: 2 }, evoFrom: 'æ³¢æ³¢', evoTo: 'å¤§æ¯”é¸Ÿ', evoFee: 'éœ€4çº¢' },
            { name: 'æ¯”æ¯”é¸Ÿ', points: 1, gem: 'water', cost: { fire: 3, electric: 2 }, evoFrom: 'æ³¢æ³¢', evoTo: 'å¤§æ¯”é¸Ÿ', evoFee: 'éœ€4çº¢' },
            { name: 'å¦™è›™è‰', points: 3, gem: 'electric', cost: { electric: 6 }, evoFrom: 'å¦™è›™ç§å­', evoTo: 'å¦™è›™èŠ±', evoFee: 'éœ€4è“' },
            { name: 'å¦™è›™è‰', points: 3, gem: 'electric', cost: { fire: 4, psychic: 4 }, evoFrom: 'å¦™è›™ç§å­', evoTo: 'å¦™è›™èŠ±', evoFee: 'éœ€4è“' },
            { name: 'é¬¼æ–¯é€š', points: 2, gem: 'electric', cost: { psychic: 5, dark: 2 }, evoFrom: 'é¬¼æ–¯', evoTo: 'è€¿é¬¼', evoFee: 'éœ€3çº¢' },
            { name: 'é¬¼æ–¯é€š', points: 2, gem: 'electric', cost: { dark: 4, psychic: 2 }, evoFrom: 'é¬¼æ–¯', evoTo: 'è€¿é¬¼', evoFee: 'éœ€3çº¢' },
            { name: 'å°¼å¤šå¨œ', points: 1, gem: 'electric', cost: { electric: 3, psychic: 2, fire: 2 }, evoFrom: 'å°¼å¤šå…°', evoTo: 'å°¼å¤šå', evoFee: 'éœ€4è“' },
            { name: 'å°¼å¤šå¨œ', points: 1, gem: 'electric', cost: { water: 3, psychic: 2 }, evoFrom: 'å°¼å¤šå…°', evoTo: 'å°¼å¤šå', evoFee: 'éœ€4è“' },
            { name: 'å‹‡åŸºæ‹‰', points: 3, gem: 'psychic', cost: { psychic: 6 }, evoFrom: 'å‡¯è¥¿', evoTo: 'èƒ¡åœ°', evoFee: 'éœ€4é»‘' },
            { name: 'å‹‡åŸºæ‹‰', points: 3, gem: 'psychic', cost: { fire: 4, electric: 4 }, evoFrom: 'å‡¯è¥¿', evoTo: 'èƒ¡åœ°', evoFee: 'éœ€4é»‘' },
            { name: 'é“ç”²è›¹', points: 2, gem: 'psychic', cost: { psychic: 5, dark: 2 }, evoFrom: 'ç»¿æ¯›è™«', evoTo: 'å·´å¤§è¶', evoFee: 'éœ€3é»„' },
            { name: 'é“ç”²è›¹', points: 2, gem: 'psychic', cost: { water: 4, fire: 2 }, evoFrom: 'ç»¿æ¯›è™«', evoTo: 'å·´å¤§è¶', evoFee: 'éœ€3é»„' },
            { name: 'èšŠé¦™å›', points: 1, gem: 'psychic', cost: { psychic: 3, water: 2, electric: 2 }, evoFrom: 'èšŠé¦™èŒèšª', evoTo: 'èšŠé¦™æ³³å£«', evoFee: 'éœ€4é»‘' },
            { name: 'èšŠé¦™å›', points: 1, gem: 'psychic', cost: { dark: 3, water: 2 }, evoFrom: 'èšŠé¦™èŒèšª', evoTo: 'èšŠé¦™æ³³å£«', evoFee: 'éœ€4é»‘' },
            { name: 'å“ˆå…‹é¾™', points: 3, gem: 'dark', cost: { dark: 6 }, evoFrom: 'è¿·ä½ é¾™', evoTo: 'å¿«é¾™', evoFee: 'éœ€4é»„' },
            { name: 'å“ˆå…‹é¾™', points: 3, gem: 'dark', cost: { water: 4, fire: 4 }, evoFrom: 'è¿·ä½ é¾™', evoTo: 'å¿«é¾™', evoFee: 'éœ€4é»„' },
            { name: 'é“å£³è›¹', points: 2, gem: 'dark', cost: { dark: 5, electric: 2 }, evoFrom: 'ç‹¬è§’è™«', evoTo: 'å¤§é’ˆèœ‚', evoFee: 'éœ€3ç´«' },
            { name: 'é“å£³è›¹', points: 2, gem: 'dark', cost: { fire: 4, water: 2 }, evoFrom: 'ç‹¬è§’è™«', evoTo: 'å¤§é’ˆèœ‚', evoFee: 'éœ€3ç´«' },
            { name: 'è‡­è‡­èŠ±', points: 1, gem: 'dark', cost: { dark: 3, water: 2, fire: 2 }, evoFrom: 'èµ°è·¯è‰', evoTo: 'éœ¸ç‹èŠ±', evoFee: 'éœ€4é»„' },
            { name: 'è‡­è‡­èŠ±', points: 1, gem: 'dark', cost: { electric: 3, water: 2 }, evoFrom: 'èµ°è·¯è‰', evoTo: 'éœ¸ç‹èŠ±', evoFee: 'éœ€4é»„' }
        ],
        lvl3: [
            { name: 'æ°´ç®­é¾Ÿ', points: 5, gem: 'fire', cost: { water: 7, dark: 3 }, evoFrom: 'å¡å’ªé¾Ÿ' },
            { name: 'æ€ªåŠ›', points: 4, gem: 'fire', cost: { electric: 6, psychic: 4 }, evoFrom: 'è±ªåŠ›' },
            { name: 'å¤§é£ŸèŠ±', points: 3, gem: 'fire', cost: { fire: 5, dark: 2 }, evoFrom: 'å£å‘†èŠ±' },
            { name: 'å–·ç«é¾™', points: 5, gem: 'water', cost: { dark: 7, electric: 3 }, evoFrom: 'ç«æé¾™' },
            { name: 'éš†éš†å²©', points: 4, gem: 'water', cost: { psychic: 6, fire: 4 }, evoFrom: 'éš†éš†çŸ³' },
            { name: 'å¤§æ¯”é¸Ÿ', points: 3, gem: 'water', cost: { water: 5, dark: 2 }, evoFrom: 'æ¯”æ¯”é¸Ÿ' },
            { name: 'å¦™è›™èŠ±', points: 5, gem: 'electric', cost: { fire: 7, psychic: 3 }, evoFrom: 'å¦™è›™è‰' },
            { name: 'è€¿é¬¼', points: 4, gem: 'electric', cost: { dark: 6, water: 4 }, evoFrom: 'é¬¼æ–¯é€š' },
            { name: 'å°¼å¤šå', points: 3, gem: 'electric', cost: { electric: 5, fire: 2 }, evoFrom: 'å°¼å¤šå¨œ' },
            { name: 'èƒ¡åœ°', points: 5, gem: 'psychic', cost: { electric: 7, fire: 3 }, evoFrom: 'å‹‡åŸºæ‹‰' },
            { name: 'å·´å¤§è¶', points: 4, gem: 'psychic', cost: { water: 6, dark: 4 }, evoFrom: 'é“ç”²è›¹' },
            { name: 'èšŠé¦™æ³³å£«', points: 3, gem: 'psychic', cost: { psychic: 5, electric: 2 }, evoFrom: 'èšŠé¦™å›' },
            { name: 'å¿«é¾™', points: 5, gem: 'dark', cost: { psychic: 7, water: 3 }, evoFrom: 'å“ˆå…‹é¾™' },
            { name: 'å¤§é’ˆèœ‚', points: 4, gem: 'dark', cost: { fire: 6, electric: 4 }, evoFrom: 'é“å£³è›¹' },
            { name: 'éœ¸ç‹èŠ±', points: 3, gem: 'dark', cost: { dark: 5, water: 2 }, evoFrom: 'è‡­è‡­èŠ±' }
        ],
        legends: [
            { name: 'æ€¥å†»é¸Ÿ', points: 2, gem: 'fire', gemCount: 2, cost: { psychic: 1, fire: 3, psychic: 3, dark: 3 } },
            { name: 'é—ªç”µé¸Ÿ', points: 2, gem: 'water', gemCount: 2, cost: { psychic: 1, psychic: 3, water: 3, electric: 3 } },
            { name: 'ç«ç„°é¸Ÿ', points: 2, gem: 'electric', gemCount: 2, cost: { psychic: 1, water: 3, electric: 3, dark: 3 } },
            { name: 'æ¢¦å¹»', points: 2, gem: 'psychic', gemCount: 2, cost: { psychic: 1, dark: 3, electric: 3, fire: 3 } },
            { name: 'è¶…æ¢¦', points: 2, gem: 'dark', gemCount: 2, cost: { psychic: 1, psychic: 3, fire: 3, water: 3 } },
            { name: 'åŒ–çŸ³ç¿¼é¾™', points: 0, gem: 'fire', gemCount: 2, cost: { psychic: 1, water: 3, psychic: 2 } },
            { name: 'æ‹‰æ™®æ‹‰æ–¯', points: 0, gem: 'water', gemCount: 2, cost: { psychic: 1, dark: 3, water: 2 } },
            { name: 'å¡æ¯”å…½', points: 0, gem: 'electric', gemCount: 2, cost: { psychic: 1, fire: 3, dark: 2 } },
            { name: 'ç™¾å˜æ€ª', points: 0, gem: 'psychic', gemCount: 2, cost: { psychic: 1, psychic: 3, electric: 2 } },
            { name: 'ä¼Šå¸ƒ', points: 0, gem: 'dark', gemCount: 2, cost: { psychic: 1, electric: 3, fire: 2 } }
        ]
    };

    function joinGame() {
        myId = document.getElementById('userId').value;
        roomId = document.getElementById('roomId').value;
        ws = new WebSocket(document.getElementById('serverUrl').value);
        ws.onopen = () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            send({ type: 'EnterRoom', room: roomId, id: myId });
            setTimeout(() => send({ type: 'SyncRequest' }), 300);
        };
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === 'UpdateState' || msg.type === 'InitializeRoomState') {
                if (msg.state) { localState = msg.state; render(); }
            }
        };
    }

    function send(data) { if(ws && ws.readyState === 1) ws.send(JSON.stringify(data)); }
    function isMyTurn() { return localState.playerOrder[localState.turnIndex] === myId; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function resetTable() {
        const playersIds = Object.keys(localState.players);
        if (playersIds.length < 1) return alert("æˆ¿é—´æ— ç©å®¶");
        const d = JSON.parse(JSON.stringify(RAW_CARDS_DATA)); 
        for(let k in d) d[k].sort(() => Math.random() - 0.5);
        let countPerColor = playersIds.length === 2 ? 4 : (playersIds.length === 3 ? 5 : 7);
        localState.tokens = { fire: countPerColor, water: countPerColor, electric: countPerColor, psychic: countPerColor, dark: countPerColor, masterball: 5 };
        localState.decks = d;
        localState.market = { lvl1: [], lvl2: [], lvl3: [], legends: [] };
        localState.playerOrder = playersIds;
        localState.turnIndex = 0;
        localState.logs = ["ç³»ç»Ÿ: æ¯”èµ›å¼€å§‹ï¼"];
        playersIds.forEach(id => {
            localState.players[id] = { tokens: {fire:0,water:0,electric:0,psychic:0,dark:0,masterball:0}, reserved: [], caught: [] };
        });
        autoRefill(); broadcast();
    }

    function endTurn() {
        if (!isMyTurn()) return alert("éä½ çš„å›åˆ");
        localState.turnIndex = (localState.turnIndex + 1) % localState.playerOrder.length;
        broadcast(`ç©å®¶ ${myId} ç»“æŸå›åˆ`);
    }

    function autoRefill() {
        const slots = { legends: 3, lvl3: 4, lvl2: 4, lvl1: 4 };
        for(let k in slots) {
            while(localState.market[k].length < slots[k] && localState.decks[k] && localState.decks[k].length > 0) {
                localState.market[k].push(localState.decks[k].pop());
            }
        }
    }

    function broadcast(log) {
        if(log) { localState.logs.push(log); if(localState.logs.length > 5) localState.logs.shift(); }
        send({ type: 'UpdateState', room: roomId, state: localState });
        render();
    }

    function buyCard(loc, idx, card, mode) {
        if (!isMyTurn()) return alert("éä½ çš„å›åˆ");
        const p = localState.players[myId];
        if (mode === 'reserve') {
            if (p.reserved.length >= 3) return alert("é¢„ç•™å·²æ»¡");
            removeFrom(loc, idx); p.reserved.push(card);
            broadcast(`${myId} é¢„ç•™äº† ${card.name}`);
        } else if (mode === 'evolve') {
            const preIdx = p.caught.findIndex(c => c.name === card.evoFrom);
            if(preIdx === -1) return alert("ç¼ºå°‘å‰ç½®å®å¯æ¢¦");
            p.caught.splice(preIdx, 1);
            removeFrom(loc, idx); p.caught.push(card);
            broadcast(`${myId} è¿›åŒ–æ•æ‰äº† ${card.name}`);
        } else {
            removeFrom(loc, idx); p.caught.push(card);
            broadcast(`${myId} æ•æ‰äº† ${card.name}`);
        }
        autoRefill(); broadcast();
    }

    function removeFrom(loc, idx) {
        if (loc === 'hand') localState.players[myId].reserved.splice(idx, 1);
        else localState.market[loc.split('_')[1]].splice(idx, 1);
    }

    function renderCard(card, onClick) {
        const el = document.createElement('div'); el.className = 'card';
        if(onClick) el.onclick = onClick;
        const icon = ICONS[card.gem] || '';
        const topIconHtml = card.isLegend ? `<span>${icon}${icon}</span>` : `<span>${icon}</span>`;
        const costHtml = Object.entries(card.cost).map(([c, n]) => `<div class="cost-bubble bg-${c}">${n}</div>`).join('');
        let evoHtml = "";
        if(card.evoTo) {
            const num = card.evoFee.match(/\d+/)[0];
            const colorClass = `bg-${COLOR_MAP[card.evoFee.replace(num, '')] || 'dark'}`;
            evoHtml = `<div class="evo-container"><div class="evo-label">è¿›åŒ– âœ</div><div class="evo-target">${card.evoTo}</div><div class="evo-cost-badge ${colorClass}">${num}</div></div>`;
        }
        el.innerHTML = `<div class="card-header"><span>${card.points||''}</span>${topIconHtml}</div><div class="card-img"><div style="font-weight:bold; font-size:11px;">${card.name}</div>${evoHtml}</div><div class="card-cost">${costHtml}</div>`;
        return el;
    }

function showOpponentDetail(pid) {
        const pData = localState.players[pid];
        if(!pData) return;
        
        document.getElementById('detailPlayerName').textContent = `è®­ç»ƒå®¶: ${pid} çš„æ¡£æ¡ˆ`;
        
        // 1. æ¸²æŸ“å¯¹æ‰‹èµ„æº (ä¸ä¸»ç•Œé¢å®Œå…¨ä¸€è‡´çš„ç™½è‰²æ–‡å­—æŠ•å½±æ•ˆæœ)
        const detailContent = document.getElementById('detailContent');
        const oldTokens = document.getElementById('detailTokensArea');
        if(oldTokens) oldTokens.remove();

        const tokenArea = document.createElement('div');
        tokenArea.id = 'detailTokensArea';
        tokenArea.className = 'detail-row';
        
        let tokenHtml = '<div class="detail-row-title">ğŸ’ æŒæœ‰èµ„æº</div>';
        tokenHtml += '<div style="display:flex; flex-wrap:wrap; gap:6px; justify-content:center; padding:10px; background:rgba(0,0,0,0.03); border-radius:8px; width:100%;">';
        
        Object.entries(pData.tokens).forEach(([c, n]) => {
            if(n > 0) { 
                tokenHtml += `
                    <div class="token bg-${c}" style="
                        width:28px; height:28px; 
                        cursor:default; border:none; 
                        font-size:11px; flex-shrink:0;
                        color: white; 
                        text-shadow: 1px 1px 1px black; /* å…³é”®ï¼šç™½è‰²æ–‡å­—æŠ•å½± */
                    ">
                        ${n}
                    </div>`;
            }
        });
        
        if (Object.values(pData.tokens).every(v => v === 0)) {
            tokenHtml += '<span style="color:#999; font-size:11px;">å£è¢‹é‡Œç©ºç©ºå¦‚ä¹Ÿ</span>';
        }
        
        tokenHtml += '</div>';
        tokenArea.innerHTML = tokenHtml;
        detailContent.prepend(tokenArea);

        // 2. æ¸²æŸ“é¢„ç•™å¡ç‰Œ
        const resDiv = document.getElementById('detailReserved'); 
        resDiv.innerHTML = '';
        if(pData.reserved.length === 0) {
            resDiv.innerHTML = '<span style="color:#999; font-size:12px;">æ— é¢„ç•™å¡ç‰Œ</span>';
        } else {
            pData.reserved.forEach(c => resDiv.appendChild(renderCard(c)));
        }
        
        // 3. æ¸²æŸ“å·²è·å¾—å›¾é‰´
        const caughtDiv = document.getElementById('detailCaught'); 
        caughtDiv.innerHTML = '';
        if(pData.caught.length === 0) {
            caughtDiv.innerHTML = '<span style="color:#999; font-size:12px;">å°šæœªæ•æ‰å®å¯æ¢¦</span>';
        } else {
            pData.caught.forEach(c => caughtDiv.appendChild(renderCard(c)));
        }
        
        document.getElementById('detailModal').style.display = 'flex';
    }

    function render() {
        const currentTurnOwner = localState.playerOrder[localState.turnIndex] || "ç­‰å¾…ä¸­";
        const indicator = document.getElementById('turnIndicator');
        const endBtn = document.getElementById('endTurnBtn');
        indicator.textContent = isMyTurn() ? "ğŸŸ¢ ä½ çš„å›åˆ" : `ğŸŸ¡ ç­‰å¾… ${currentTurnOwner}`;
        indicator.style.color = isMyTurn() ? "#00ff00" : "#ffcb05";
        endBtn.style.background = isMyTurn() ? "#4caf50" : "#444";
        document.getElementById('roomDisplay').textContent = `è®­ç»ƒå®¶: ${myId} | æˆ¿é—´: ${roomId}`;
        document.getElementById('gameLog').innerHTML = localState.logs.map(l => `<div>${l}</div>`).join('');

        // æ¸²æŸ“å¸‚åœº
        const mArea = document.getElementById('marketArea'); mArea.innerHTML = '';
        const rows = { legends: 'ç¨€æœ‰', lvl3: 'æœ€ç»ˆ', lvl2: 'äºŒé˜¶', lvl1: 'ä¸€é˜¶' };
        Object.entries(rows).forEach(([k, label]) => {
            const r = document.createElement('div'); r.className = 'card-row';
            const count = localState.decks[k] ? localState.decks[k].length : 0;
            r.innerHTML = `<div class="row-info"><div>${label}</div><div style="font-size:9px;">åº“:${count}</div></div>`;
            (localState.market[k] || []).forEach((c, i) => r.appendChild(renderCard(c, () => showAction(`market_${k}`, i, c))));
            mArea.appendChild(r);
        });

        // æ¸²æŸ“é“¶è¡Œ
        const bank = document.getElementById('bankTokens'); bank.innerHTML = '';
        ['fire', 'water', 'electric', 'psychic', 'dark', 'masterball'].forEach(c => {
            const t = document.createElement('div'); t.className = `token bg-${c}`; t.textContent = localState.tokens[c] || 0;
            t.onclick = () => { if(isMyTurn() && localState.tokens[c] > 0){ localState.tokens[c]--; localState.players[myId].tokens[c]++; broadcast(); } };
            bank.appendChild(t);
        });

        // æ¸²æŸ“æˆ‘çš„é¢æ¿
        const me = localState.players[myId];
        if(me) {
            const tBox = document.getElementById('myTokensContainer'); tBox.innerHTML = '';
            Object.entries(me.tokens).forEach(([c, n]) => { if(n>0) {
                const el = document.createElement('div'); el.className = `token bg-${c}`; el.style.width='28px'; el.style.height='28px'; el.textContent = n;
                el.onclick = () => { if(isMyTurn()) { me.tokens[c]--; localState.tokens[c]++; broadcast(); } }; 
                tBox.appendChild(el);
            }});
            const h = document.getElementById('myHandContainer'); h.innerHTML = '';
            me.reserved.forEach((c, i) => h.appendChild(renderCard(c, () => showAction('hand', i, c))));
            const tab = document.getElementById('myTableauContainer'); tab.innerHTML = '';
            me.caught.forEach(c => tab.appendChild(renderCard(c)));
        }

        // æ¸²æŸ“å¯¹æ‰‹åˆ—è¡¨
        const oppDiv = document.getElementById('opponentsList'); oppDiv.innerHTML = '';
        Object.entries(localState.players).forEach(([pid, pData]) => {
            if(pid === myId) return;
            const score = pData.caught.reduce((sum, c) => sum + (c.points || 0), 0);
            const item = document.createElement('div');
            item.className = 'opp-item';
            item.onclick = () => showOpponentDetail(pid);
            item.innerHTML = `<div>${pid} ğŸ† ç§¯åˆ†: <b>${score}</b></div><div style="color:#aaa; margin-top:4px;">èµ„æº:${Object.values(pData.tokens).reduce((a,b)=>a+b,0)} | é¢„ç•™:${pData.reserved.length} | å·²å¾—:${pData.caught.length}</div>`;
            oppDiv.appendChild(item);
        });
    }

    function showAction(loc, idx, card) {
        if (!isMyTurn()) return alert("ä¸æ˜¯ä½ çš„å›åˆ");
        const modal = document.getElementById('actionModal');
        const btns = document.getElementById('modalButtons');
        document.getElementById('modalCardName').textContent = card.name;
        btns.innerHTML = '';
        const add = (txt, col, fn) => {
            const b = document.createElement('button'); b.className = 'modal-btn'; b.style.background = col; b.textContent = txt;
            b.onclick = () => { fn(); closeModal('actionModal'); }; btns.appendChild(b);
        };
        if (loc !== 'hand') {
            add('ç›´æ¥æ•æ‰', '#4caf50', () => buyCard(loc, idx, card, 'buy'));
            add('é¢„ç•™å¡ç‰Œ', '#ff9800', () => buyCard(loc, idx, card, 'reserve'));
            if(card.evoFrom) add(`è¿›åŒ–æ•æ‰`, '#2196f3', () => buyCard(loc, idx, card, 'evolve'));
        } else {
            add('ä»æ‰‹ç‰Œæ‰“å‡º', '#4caf50', () => buyCard(loc, idx, card, 'buy'));
        }
        modal.style.display = 'flex';
    }
</script>
</body>
</html>
