<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>WebRTC P2P æˆ¿é—´èŠå¤©</title>

  <!-- Socket.IO CDN -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    input, button {
      padding: 6px;
      margin: 4px;
    }
    #log {
      background: #111;
      color: #0f0;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <h2>âœ… WebRTC P2P å¤šäººæˆ¿é—´èŠå¤© Demo</h2>

  <p>
    æˆ¿é—´å·ï¼š
    <input id="room" value="room1" />
    <button id="joinBtn">åŠ å…¥æˆ¿é—´</button>
  </p>

  <hr />

  <p>
    æ¶ˆæ¯ï¼š
    <input id="msg" placeholder="è¾“å…¥æ¶ˆæ¯..." />
    <button id="sendBtn">å‘é€</button>
  </p>

  <pre id="log"></pre>

<script>
let pc;
let channel;
let socket;
let room;

function log(msg) {
  const box = document.getElementById("log");
  box.textContent += msg + "\n";
  box.scrollTop = box.scrollHeight;
}

document.getElementById("joinBtn").onclick = async () => {
  room = document.getElementById("room").value;

  // âš ï¸æ”¹æˆä½ è‡ªå·±çš„ Render ä¿¡ä»¤æœåŠ¡å™¨åœ°å€
  socket = io("https://YOUR-SIGNAL-SERVER.onrender.com");

  socket.emit("join", room);

  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  // ICE candidate è½¬å‘
  pc.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit("signal", {
        room,
        data: { candidate: e.candidate }
      });
    }
  };

  // æ¥æ”¶ DataChannel
  pc.ondatachannel = (e) => {
    channel = e.channel;
    setupChannel();
  };

  // æ”¶åˆ°ä¿¡ä»¤æ¶ˆæ¯
  socket.on("signal", async (data) => {

    if (data.offer) {
      log("ğŸ“© æ”¶åˆ° offer");

      await pc.setRemoteDescription(data.offer);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      socket.emit("signal", {
        room,
        data: { answer }
      });
    }

    if (data.answer) {
      log("ğŸ“© æ”¶åˆ° answer");
      await pc.setRemoteDescription(data.answer);
    }

    if (data.candidate) {
      await pc.addIceCandidate(data.candidate);
    }
  });

  // åˆ›å»º DataChannelï¼ˆç¬¬ä¸€ä¸ªåŠ å…¥çš„äººï¼‰
  channel = pc.createDataChannel("chat");
  setupChannel();

  // å‘ offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  socket.emit("signal", {
    room,
    data: { offer }
  });

  log("âœ… å·²åŠ å…¥æˆ¿é—´ï¼š" + room);
};

function setupChannel() {
  channel.onopen = () => log("ğŸ‰ P2P é€šé“å·²å»ºç«‹ï¼");
  channel.onmessage = (e) => log("æœ‹å‹: " + e.data);
}

document.getElementById("sendBtn").onclick = () => {
  const msg = document.getElementById("msg").value;
  if (!channel || channel.readyState !== "open") {
    alert("P2P é€šé“è¿˜æ²¡å»ºç«‹ï¼");
    return;
  }
  channel.send(msg);
  log("æˆ‘: " + msg);
};
</script>

</body>
</html>
