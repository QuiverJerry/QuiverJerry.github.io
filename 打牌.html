function initPeer() {
    // === 关键修改：指定国内可用的 STUN 服务器 ===
    const peerConfig = {
        config: {
            iceServers: [
                { urls: 'stun:stun.miwifi.com' },      // 小米 STUN
                { urls: 'stun:stun.qq.com:3478' },     // 腾讯 STUN
                { urls: 'stun:stun.chat.bilibili.com'} // B站 STUN
            ]
        }
        // 如果上面都不行，PeerJS 官方服务器可能也会偶尔被墙
    };

    peer = new Peer(peerConfig); 
    
    // --- 下面是原来的逻辑，保持不变 ---
    peer.on('open', (id) => {
        log(`我的 ID: ${id}`);
        document.getElementById('roleSelect').classList.add('hidden');
        document.getElementById('gameArea').classList.remove('hidden');
        document.getElementById('myIdDisplay').innerText = `ID: ${id}`;
        
        if(isHost) {
            alert(`房间已创建！\n请把这个 ID 发给朋友：\n${id}`);
            document.getElementById('hostControls').classList.remove('hidden');
        }
    });

    peer.on('connection', (c) => {
        if (isHost) {
            log(`玩家 ${c.peer} 已加入!`);
            connections.push(c);
            setupConnection(c);
        }
    });

    peer.on('error', (err) => {
        console.error(err);
        // 增加更详细的错误提示
        if (err.type === 'peer-unavailable') {
            alert("❌ 找不到 ID (可能房主切后台了)");
        } else if (err.type === 'network') {
            alert("❌ 网络连接失败 (可能是 STUN 服务器连不上，或者 WiFi 防火墙拦截)");
        } else if (err.type === 'server-error') {
            alert("❌ PeerJS 官方信令服务器挂了，请稍后再试");
        } else {
            alert("发生错误: " + err.type);
        }
        log(`错误: ${err.type}`);
    });
}
